'use client'

import { useState, useEffect } from 'react'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Trash2 } from 'lucide-react'
import { toast } from 'sonner'
import { SketchPicker } from 'react-color'

interface Wallpaper {
  id: string
  url: string
  width: number
  height: number
  opacity: number
}

interface TabSettings {
  backgroundColor: string
  textColor: string
  buttonColor: string
  buttonTextColor: string
  navigationColor: string
  navigationTextColor: string
  navigationOpacity: number
  opacity: number
  containerOpacity?: number
  blur: number
  wallpapers: Wallpaper[]
  containerBackgroundColor?: string
  wallpaperMode?: 'floating' | 'cover'
}

interface GlobalSettings {
  [key: string]: TabSettings
}

export default function Home() {
  const [isAdmin, setIsAdmin] = useState(false)
  const [settings, setSettings] = useState<GlobalSettings>({})
  const [mounted, setMounted] = useState(false)
  const [activeTab, setActiveTab] = useState<string>('home')
  const [passwordInput, setPasswordInput] = useState('')
  const [showPasswordDialog, setShowPasswordDialog] = useState(false)
  const [adminPassword, setAdminPassword] = useState('Admin@123456')
  const [currentPassword, setCurrentPassword] = useState('')
  const [newPassword, setNewPassword] = useState('')
  const [confirmPassword, setConfirmPassword] = useState('')
  const [openColorPicker, setOpenColorPicker] = useState<string | null>(null)

  const defaultSettings: GlobalSettings = {
    home: {
      backgroundColor: '#ffffff',
      containerBackgroundColor: '#ffffff',
      containerOpacity: 1,
      textColor: '#1f2937',
      buttonColor: '#3b82f6',
      buttonTextColor: '#ffffff',
      navigationColor: '#ffffff',
      navigationTextColor: '#1f2937',
      navigationOpacity: 0.95,
      opacity: 0.85,
      blur: 10,
      wallpapers: []
      , wallpaperMode: 'floating'
    },
    about: {
      backgroundColor: '#f3f4f6',
      containerBackgroundColor: '#ffffff',
      containerOpacity: 1,
      textColor: '#1f2937',
      buttonColor: '#10b981',
      buttonTextColor: '#ffffff',
      navigationColor: '#ffffff',
      navigationTextColor: '#1f2937',
      navigationOpacity: 0.95,
      opacity: 0.85,
      blur: 10,
      wallpapers: []
      , wallpaperMode: 'floating'
    },
    services: {
      backgroundColor: '#fef3c7',
      containerBackgroundColor: '#ffffff',
      containerOpacity: 1,
      textColor: '#92400e',
      buttonColor: '#f59e0b',
      buttonTextColor: '#ffffff',
      navigationColor: '#ffffff',
      navigationTextColor: '#92400e',
      navigationOpacity: 0.95,
      opacity: 0.85,
      blur: 10,
      wallpapers: []
      , wallpaperMode: 'floating'
    },
    contact: {
      backgroundColor: '#e0e7ff',
      containerBackgroundColor: '#ffffff',
      containerOpacity: 1,
      textColor: '#312e81',
      buttonColor: '#6366f1',
      buttonTextColor: '#ffffff',
      navigationColor: '#ffffff',
      navigationTextColor: '#312e81',
      navigationOpacity: 0.95,
      opacity: 0.85,
      blur: 10,
      wallpapers: []
      , wallpaperMode: 'floating'
    }
  }

  const hexToRgba = (hex: string, alpha = 1) => {
    const h = hex.replace('#', '')
    const bigint = parseInt(h, 16)
    const r = (bigint >> 16) & 255
    const g = (bigint >> 8) & 255
    const b = bigint & 255
    return `rgba(${r}, ${g}, ${b}, ${alpha})`
  }

  useEffect(() => {
    setMounted(true)
    try {
      const saved = localStorage.getItem('tabSettings')
      if (saved) {
        setSettings(JSON.parse(saved))
      } else {
        setSettings(defaultSettings)
      }
      const savedPassword = localStorage.getItem('adminPassword')
      if (savedPassword) {
        setAdminPassword(savedPassword)
      }
    } catch {
      setSettings(defaultSettings)
    }
  }, [])

  const saveSettings = (newSettings: GlobalSettings) => {
    setSettings(newSettings)
    localStorage.setItem('tabSettings', JSON.stringify(newSettings))
    toast.success('Settings saved âœ“')
  }

  const updateSetting = (tab: string, key: string, value: any) => {
    const newSettings = {
      ...settings,
      [tab]: {
        ...settings[tab],
        [key]: value
      }
    }
    saveSettings(newSettings)
  }

  const addWallpaper = (tab: string, file: File) => {
    if (file.size > 5 * 1024 * 1024) {
      toast.error('Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ú©Ù…ØªØ± Ø§Ø² 5MB Ø¨Ø§Ø´Ø¯')
      return
    }

    const reader = new FileReader()
    reader.onload = (e) => {
      const url = e.target?.result as string
      const newWallpaper: Wallpaper = {
        id: Date.now().toString(),
        url,
        width: 150,
        height: 150,
        opacity: 1
      }

      const wallpapers = [...(settings[tab]?.wallpapers || []), newWallpaper]
      updateSetting(tab, 'wallpapers', wallpapers)
      toast.success('Wallpaper added âœ“')
    }
    reader.readAsDataURL(file)
  }

  const removeWallpaper = (tab: string, id: string) => {
    const wallpapers = (settings[tab]?.wallpapers || []).filter(w => w.id !== id)
    updateSetting(tab, 'wallpapers', wallpapers)
    toast.success('Wallpaper deleted âœ“')
  }

  const updateWallpaper = (tab: string, id: string, key: string, value: any) => {
    const wallpapers = (settings[tab]?.wallpapers || []).map(w =>
      w.id === id ? { ...w, [key]: value } : w
    )
    updateSetting(tab, 'wallpapers', wallpapers)
  }

  if (!mounted) return null

  const TabContent = ({ tabName }: { tabName: string }) => {
    const s = settings[tabName] || defaultSettings[tabName]

    return (
      <TabsContent value={tabName} className="mt-8">
        {isAdmin && (
          <Card className="mb-8 bg-white/90 shadow-md rounded-lg">
            <CardHeader className="bg-transparent border-b">
              <CardTitle className="text-2xl" style={{ color: s.navigationTextColor }}>âš™ï¸ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¨: {tabName}</CardTitle>
            </CardHeader>
            <CardContent className="pt-6 space-y-6">
              {/* Ø±Ù†Ú¯â€ŒÙ‡Ø§ */}
              <div className="border-b pb-6">
                <h3 className="text-xl font-bold mb-4">ğŸ¨ Ø±Ù†Ú¯â€ŒÙ‡Ø§</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {[
                    { key: 'backgroundColor', label: 'Page Background' },
                    { key: 'containerBackgroundColor', label: 'Container Background' },
                    { key: 'textColor', label: 'Ù…ØªÙ†' },
                    { key: 'buttonColor', label: 'Button Color' },
                    { key: 'buttonTextColor', label: 'Button Text' },
                    { key: 'navigationColor', label: 'Navigation Background' },
                    { key: 'navigationTextColor', label: 'Navigation Text' }
                  ].map(({ key, label }) => (
                    <div key={key} className="p-3 bg-gray-50/80 rounded-lg border border-gray-200 relative">
                      <Label className="font-bold">{label}</Label>
                      <div className="flex gap-2 mt-2 items-center">
                        {/* Color Preview */}
                        <button
                          onClick={() => setOpenColorPicker(openColorPicker === key ? null : key)}
                          style={{ backgroundColor: (s as any)[key] || '#ffffff' }}
                          className="w-16 h-10 border-2 border-gray-400 rounded cursor-pointer shadow-md hover:shadow-lg transition"
                          title="Click to open color picker"
                        />
                        
                        {/* Hex Input */}
                        <Input
                          value={(s as any)[key]}
                          onChange={(e) => {
                            if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                              updateSetting(tabName, key, e.target.value)
                            }
                          }}
                          className="flex-1 border-2"
                          placeholder="#ffffff"
                        />
                      </div>

                      {/* Color Picker Dropdown */}
                      {openColorPicker === key && (
                        <div className="absolute top-full left-0 z-50 mt-2 bg-white rounded-lg shadow-2xl p-4 border border-gray-200">
                          <SketchPicker
                            color={(s as any)[key] || '#ffffff'}
                            onChange={(color) => updateSetting(tabName, key, color.hex)}
                            width="250px"
                          />
                          <button
                            onClick={() => setOpenColorPicker(null)}
                            className="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-md text-sm font-bold"
                          >
                            Done
                          </button>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              {/* Ø§Ø³Ù„Ø§ÛŒØ¯Ø±Ù‡Ø§ */}
              <div className="border-b pb-6">
                <h3 className="text-xl font-bold mb-4">ğŸ“Š Ø§ÙÚ©Øªâ€ŒÙ‡Ø§</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="p-3 bg-blue-50/70 rounded-lg border border-blue-100">
                    <Label className="font-bold">Background Opacity: {Math.round(s.opacity * 100)}%</Label>
                    <input
                      type="range"
                      min="0"
                      max="100"
                      value={Math.round(s.opacity * 100)}
                      onChange={(e) => updateSetting(tabName, 'opacity', Number(e.target.value) / 100)}
                      className="w-full mt-2"
                    />
                  </div>

                  <div className="p-3 bg-purple-50/70 rounded-lg border border-purple-100">
                    <Label className="font-bold">ØªØ§Ø±ÛŒ: {s.blur}px</Label>
                    <input
                      type="range"
                      min="0"
                      max="50"
                      value={s.blur}
                      onChange={(e) => updateSetting(tabName, 'blur', Number(e.target.value))}
                      className="w-full mt-2"
                    />
                  </div>

                  <div className="p-3 bg-green-50/70 rounded-lg border border-green-100">
                    <Label className="font-bold">Navigation Opacity: {Math.round(s.navigationOpacity * 100)}%</Label>
                    <input
                      type="range"
                      min="0"
                      max="100"
                      value={Math.round(s.navigationOpacity * 100)}
                      onChange={(e) => updateSetting(tabName, 'navigationOpacity', Number(e.target.value) / 100)}
                      className="w-full mt-2"
                    />
                  </div>
                  <div className="p-3 bg-yellow-50/70 rounded-lg border border-yellow-100">
                    <Label className="font-bold">Container Opacity: {Math.round((s.containerOpacity ?? 1) * 100)}%</Label>
                    <input
                      type="range"
                      min="0"
                      max="100"
                      value={Math.round((s.containerOpacity ?? 1) * 100)}
                      onChange={(e) => updateSetting(tabName, 'containerOpacity', Number(e.target.value) / 100)}
                      className="w-full mt-2"
                    />
                  </div>
                </div>
              </div>

              {/* ÙˆØ§Ù„Ù¾ÛŒÙ¾Ø±Ù‡Ø§ */}
              <div>
                <h3 className="text-xl font-bold mb-4">ğŸ–¼ï¸ ÙˆØ§Ù„Ù¾ÛŒÙ¾Ø±Ù‡Ø§</h3>
                <div className="mb-4">
                  <Label className="font-bold">Wallpaper Mode</Label>
                  <select
                    value={s.wallpaperMode || 'floating'}
                    onChange={(e) => updateSetting(tabName, 'wallpaperMode', e.target.value)}
                    className="w-full p-2 border rounded-md"
                  >
                    <option value="floating">Floating</option>
                    <option value="cover">Cover (Full Page)</option>
                  </select>
                </div>
                <input
                  type="file"
                  accept="image/*"
                  onChange={(e) => e.target.files?.[0] && addWallpaper(tabName, e.target.files[0])}
                  className="hidden"
                  id={`file-${tabName}`}
                />
                <Button
                  onClick={() => document.getElementById(`file-${tabName}`)?.click()}
                  className="w-full bg-yellow-500/90 hover:bg-yellow-600 text-white font-medium mb-4"
                >
                  ğŸ“ Upload Wallpaper
                </Button>

                <div className="space-y-3">
                  {s.wallpapers.map((wp) => (
                    <div key={wp.id} className="rounded-lg p-4 bg-gray-50/90 shadow-sm">
                      <div className="flex gap-4 mb-4">
                        <img src={wp.url} alt="wallpaper" className="w-20 h-20 object-cover rounded" />
                        <div className="flex-1">
                          <p className="font-bold">{wp.width}x{wp.height}px</p>
                          <p className="text-sm">Opacity: {Math.round(wp.opacity * 100)}%</p>
                          <Button
                            onClick={() => removeWallpaper(tabName, wp.id)}
                            size="sm"
                            className="mt-2 bg-red-500/90 hover:bg-red-600"
                          >
                            <Trash2 className="w-4 h-4 mr-2" />
                            Delete
                          </Button>
                        </div>
                      </div>

                      { (s.wallpaperMode || 'floating') === 'floating' ? (
                        <div className="grid grid-cols-3 gap-2">
                          <div>
                            <Label className="text-xs">Width: {wp.width}px</Label>
                            <input
                              type="range"
                              min="50"
                              max="400"
                              value={wp.width}
                              onChange={(e) => updateWallpaper(tabName, wp.id, 'width', Number(e.target.value))}
                              className="w-full mt-1"
                            />
                          </div>
                          <div>
                            <Label className="text-xs">Height: {wp.height}px</Label>
                            <input
                              type="range"
                              min="50"
                              max="400"
                              value={wp.height}
                              onChange={(e) => updateWallpaper(tabName, wp.id, 'height', Number(e.target.value))}
                              className="w-full mt-1"
                            />
                          </div>
                          <div>
                            <Label className="text-xs">Opacity: {Math.round(wp.opacity * 100)}%</Label>
                            <input
                              type="range"
                              min="0"
                              max="100"
                              value={Math.round(wp.opacity * 100)}
                              onChange={(e) => updateWallpaper(tabName, wp.id, 'opacity', Number(e.target.value) / 100)}
                              className="w-full mt-1"
                            />
                          </div>
                        </div>
                      ) : (
                        <div>
                          <Label className="text-xs">Opacity (Cover): {Math.round(wp.opacity * 100)}%</Label>
                          <input
                            type="range"
                            min="0"
                            max="100"
                            value={Math.round(wp.opacity * 100)}
                            onChange={(e) => updateWallpaper(tabName, wp.id, 'opacity', Number(e.target.value) / 100)}
                            className="w-full mt-1"
                          />
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Content */}
        <div style={{ position: 'relative', minHeight: '70vh', borderRadius: '1rem', overflow: 'hidden' }}>
          {/* Overlay placed behind wallpapers and content container so container background remains visible */}
          <div style={{
            position: 'absolute',
            inset: 0,
            backgroundColor: hexToRgba(s.backgroundColor, s.opacity),
            zIndex: 1
          }} />

          {/* Wallpapers (between overlay and content container) */}
          <div style={{ position: 'absolute', inset: 0, zIndex: 2, pointerEvents: 'none', overflow: 'hidden' }}>
            { (s.wallpaperMode || 'floating') === 'cover' && s.wallpapers[0] ? (
              <div
                style={{
                  position: 'absolute',
                  inset: 0,
                  backgroundImage: `url(${s.wallpapers[0].url})`,
                  backgroundSize: 'cover',
                  backgroundPosition: 'center',
                  opacity: s.wallpapers[0].opacity,
                  zIndex: 2
                }}
              />
            ) : (
              s.wallpapers.map((wp) => (
                <div
                  key={wp.id}
                  style={{
                    position: 'absolute',
                    backgroundImage: `url(${wp.url})`,
                    backgroundSize: 'cover',
                    width: `${wp.width}px`,
                    height: `${wp.height}px`,
                    opacity: wp.opacity,
                    left: `${Math.random() * 80}%`,
                    top: `${Math.random() * 80}%`,
                    borderRadius: '12px',
                    boxShadow: '0 8px 16px rgba(0,0,0,0.12)'
                  }}
                />
              ))
            )}
          </div>

          {/* Content container (on top) */}
          <div style={{
            position: 'relative',
            zIndex: 3,
            padding: '3rem 2rem',
            color: s.textColor,
            minHeight: '70vh',
            display: 'flex',
            flexDirection: 'column',
            justifyContent: 'center',
            backgroundColor: hexToRgba(s.containerBackgroundColor || s.backgroundColor, s.containerOpacity ?? 1),
            borderRadius: '0.75rem'
          }}>
            <div className="text-center space-y-6">
              <h2 className="text-5xl font-bold">Tab {tabName}</h2>
              <p className="text-xl">Page content</p>
              <Card style={{ borderColor: s.buttonColor, backgroundColor: hexToRgba(s.buttonColor, 0.06) }}>
                <CardContent className="pt-6">
                  <p>Button Color: <span style={{ color: s.buttonColor }} className="font-bold">{s.buttonColor}</span></p>
                </CardContent>
              </Card>
              <div>
                <button
                  onClick={() => toast('Clicked!')}
                  style={{ backgroundColor: s.buttonColor, color: s.buttonTextColor }}
                  className="rounded-md text-lg px-8 py-3 mt-4 shadow"
                >
                  ğŸš€ Button {tabName}
                </button>
              </div>
            </div>
          </div>
        </div>
      </TabsContent>
    )
  }

  const navOpacity = settings[activeTab]?.navigationOpacity ?? settings.home?.navigationOpacity ?? 0.95

  const handlePasswordSubmit = () => {
    if (passwordInput === adminPassword) {
      setIsAdmin(true)
      setShowPasswordDialog(false)
      setPasswordInput('')
      toast.success('Admin access granted âœ“')
    } else {
      toast.error('Incorrect password!')
      setPasswordInput('')
    }
  }

  const handleChangePassword = () => {
    if (!currentPassword) {
      toast.error('Enter current password')
      return
    }
    if (currentPassword !== adminPassword) {
      toast.error('Current password is incorrect')
      return
    }
    if (!newPassword || newPassword.length < 6) {
      toast.error('New password must be at least 6 characters')
      return
    }
    if (newPassword !== confirmPassword) {
      toast.error('Passwords do not match')
      return
    }
    if (newPassword === currentPassword) {
      toast.error('New password must be different from current')
      return
    }
    setAdminPassword(newPassword)
    localStorage.setItem('adminPassword', newPassword)
    setCurrentPassword('')
    setNewPassword('')
    setConfirmPassword('')
    toast.success('Password changed successfully âœ“')
  }

  return (
    <div className="min-h-screen" style={{ backgroundColor: settings[activeTab]?.backgroundColor || 'var(--color-gray-100)' }}>
      {/* Password Dialog */}
      {showPasswordDialog && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[9999]">
          <div className="bg-white rounded-lg p-8 shadow-2xl max-w-sm">
            <h2 className="text-2xl font-bold mb-4">ğŸ” Admin Password</h2>
            <input
              type="password"
              placeholder="Enter admin password"
              value={passwordInput}
              onChange={(e) => setPasswordInput(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handlePasswordSubmit()}
              className="w-full p-2 border rounded-md mb-4"
              autoFocus
            />
            <div className="flex gap-2">
              <button
                onClick={handlePasswordSubmit}
                className="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-md"
              >
                Submit
              </button>
              <button
                onClick={() => {
                  setShowPasswordDialog(false)
                  setPasswordInput('')
                }}
                className="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-md"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Navigation */}
      <nav
        className="sticky top-0 z-50 p-4 mb-8 shadow-xl"
        style={{
          backgroundColor: hexToRgba(settings[activeTab]?.navigationColor || settings.home?.navigationColor || '#ffffff', navOpacity),
          color: settings[activeTab]?.navigationTextColor || settings.home?.navigationTextColor || '#000',
          backdropFilter: 'blur(10px)',
          borderBottom: '2px solid rgba(0,0,0,0.06)'
        }}
      >
        <div className="container mx-auto flex justify-between items-center">
          <h1 className="text-3xl font-bold">ğŸ¨ Customization Site</h1>
          <div
            className="inline-flex items-center rounded-md px-2 py-1"
            style={{ backgroundColor: 'transparent', backdropFilter: 'none' }}
          >
            <div className="flex items-center space-x-2 mr-2">
              {['home', 'about', 'services', 'contact'].map((t) => {
                return (
                  <button
                    key={t}
                    onClick={() => setActiveTab(t)}
                    className={`rounded-md px-4 py-2 text-lg font-bold shadow ${activeTab === t ? 'shadow-sm' : 'hover:brightness-95'}`}
                    style={{
                      color: settings[activeTab]?.buttonTextColor || '#fff',
                      backgroundColor: settings[activeTab]?.buttonColor || '#f59e0b'
                    }}
                  >
                    {t === 'home' ? 'Home' : t === 'about' ? 'About' : t === 'services' ? 'Services' : 'Contact'}
                  </button>
                )
              })}
            </div>

            <button
              onClick={() => {
                if (isAdmin) {
                  setIsAdmin(false)
                  setPasswordInput('')
                } else {
                  setShowPasswordDialog(true)
                }
              }}
              style={{ backgroundColor: settings[activeTab]?.buttonColor || '#f59e0b', color: settings[activeTab]?.buttonTextColor || '#fff' }}
              className="rounded-md px-4 py-2 text-lg font-bold shadow"
            >
              {isAdmin ? 'âœ“ Admin Active' : 'ğŸ”’ Enter Admin'}
            </button>
          </div>
        </div>
      </nav>

      {/* ØªØ¨â€ŒÙ‡Ø§ */}
      <div className="container mx-auto px-4 pb-8">
        <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v)} className="w-full">
          {/* Tabs are controlled via nav buttons in the top bar */}

          <TabContent tabName="home" />
          <TabContent tabName="about" />
          <TabContent tabName="services" />
          <TabContent tabName="contact" />
        </Tabs>
      </div>
    </div>
  )
}
